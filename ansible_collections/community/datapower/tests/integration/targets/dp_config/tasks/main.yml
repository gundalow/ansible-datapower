- name: Ensure WebGUI is enabled prior to test
  community.datapower.config:
    domain: default
    class_name: WebGUI
    name: WebGUI-Settings
    state: present
    config:
      mAdminState: enabled

- name: Get WebGUI
  community.datapower.get_config:
    domain: default
    class_name: WebGUI
  register: before

- name: Assert WebGui configuration was retrieved.
  assert:
    that:
      - "{{ before['response']['WebGUI']['mAdminState'] == 'enabled' }}"

- name: Disable the WebGUI object
  community.datapower.config:
    domain: default
    class_name: WebGUI
    name: WebGUI-Settings
    state: present
    config:
      mAdminState: disabled
  register: config_webgui_disabled

- name: Get WebGUI
  community.datapower.get_config:
    domain: default
    class_name: WebGUI
  register: changed

- name: Assert config changed and task "Disable the WebGUI object" changed is true
  assert:
    that:
      - "{{ changed['response']['WebGUI']['mAdminState'] == 'disabled' }}"
      - "{{ changed != before  }}"
      - config_webgui_disabled.changed == true

- name: Make same change as "Disable the WebGUI object"
  community.datapower.config:
    domain: default
    class_name: WebGUI
    name: WebGUI-Settings
    state: present
    config:
      mAdminState: disabled
  register: config_webgui_disabled_not_changed

- name: Get WebGUI
  community.datapower.get_config:
    domain: default
    class_name: WebGUI
  register: unchanged

- name: Assert state is unchanged and task 'Make same change as "Disable the WebGUI object"' changed is false
  assert:
    that:
      - "{{ changed == unchanged  }}"
      - config_webgui_disabled_not_changed.changed == false

- name: Delete SSL Profile
  community.datapower.config:
    domain: default
    state: absent
    config:
      SSLClientProfile:
        name: tls-client-profile

- name: Delete Crypto ValCred
  community.datapower.config:
    domain: default
    state: absent
    config:
      CryptoValCred:
        name: valcred

- name: Create Test1 Crypto Certficiate
  community.datapower.config:
    domain: default
    state: present
    config:
      CryptoCertificate:
        name: Test1
        Filename: cert:///webgui-sscert.pem

- name: Create Test2 Crypto Certficiate
  community.datapower.config:
    domain: default
    state: present
    config:
      CryptoCertificate:
        name: Test2
        Filename: cert:///webgui-sscert.pem

- name: Create Crypto ValCred
  community.datapower.config:
    domain: default
    state: present
    config:
      CryptoValCred:
        name: valcred

- name: Update a CryptoValCred Certificate list property to 1 item.
  community.datapower.config:
    domain: default
    state: present
    config:
      CryptoValCred:
        Certificate:
        - value: Test1
        name: valcred
  register: valcred_result

- name: Get valcred to check its state was update.
  community.datapower.get_config:
    domain: default
    class_name: CryptoValCred
    name: valcred
  register: valcred

- name: Assert the CryptoValCred Certificate list was updated to 1 item.
  assert:
    that:
      - "{{ valcred['response']['CryptoValCred']['Certificate']['value'] is defined }}"
      - "{{ valcred_result['response']['valcred'] == 'Configuration was updated.'  }}"
  ignore_errors: no

- name: Update a CryptoValCred Certificate list property to 2 items.
  community.datapower.config:
    domain: default
    state: present
    config:
      CryptoValCred:
        Certificate:
        - value: Test2
        - value: Test1
        name: valcred
  register: valcred_result

- name: Assert the CryptoValCred Certificate list was updated to 2 items.
  assert:
    that:
      - "{{ valcred['response']['CryptoValCred']['Certificate'] | length == 2 }}"
      - "{{ valcred_result['response']['valcred'] == 'Configuration was updated.' }}"